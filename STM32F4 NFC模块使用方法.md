# STM32F4 NFC模块使用方法

近场通信（Near Field Communication，NFC），又称近距离无线通信，是一种短距离的高频无线通信技术，允许电子设备之间进行非接触式点对点数据传输（在10cm内）交换数据。这个技术由免接触式射频识别技术（RFID）演变而来，并且向下兼容RFID。**注意：本篇使用的是PN532模块和S50卡。**

------ 这世道，写个教程还要想想怎么开头 ------
------ 这世道，写个开头还是抄来的 ------

好了，言归正传，直接上NFC读写卡的操作步骤：

> 1. 唤醒
> 2. 寻卡
> 3. 验证
> 4. 读写

> PS：除了读写操作之外，还有比较常用的 增加 减少 操作，以及相对用的比较少的 恢复 和 转存 操作，这些操作不是本篇的重点，仅提出供大家学习交流。

### 一、唤醒

应该是PN532带了一个休眠功能，要使用PN532对NFC卡片进行读写的时候要先唤醒一下。过程很简单，写程序的时候加在`main`函数里就可以了，一般就只运行一遍就好。
唤醒命令（十六进制，下同）如下：

```
55 55 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF 03 FD D4 14 01 17 00 
```
唤醒命令详细解释如下图：

![唤醒命令](http://onmw6wg88.bkt.clouddn.com/NFC%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F.001.jpeg)

成功唤醒后PN532模块会返回如下数据：

```
00 00 FF 00 FF 00 00 00 FF 02 FE D5 15 16 00 
```
唤醒响应数据详细解释如下图：

![唤醒响应](http://onmw6wg88.bkt.clouddn.com/NFC%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F.002.jpeg)

基本上唤醒没什么好说的，这个步骤还不关卡片的事情，所以如果你要是没得到PN532模块相应的响应数据，请不要怀疑你的NFC卡片出了什么问题，赶紧检查下你的代码和接线吧～

### 二、寻卡

寻卡，又称识别卡片。相比于上一步的唤醒，识别卡片的步骤就重要的多了（敲黑板！！！）。现实中的那种对不起砍错人了的事情是不会在NFC的世界里出现的。NFC对卡的操作都是要先认识卡的。主要是因为接下来的读写操作中不会再对卡进行身份确认了。

寻卡命令如下：

```
00 00 FF 04 FC D4 4A 01 00 E1 00
```

寻卡命令的详细解释如下图：

![寻卡命令](http://onmw6wg88.bkt.clouddn.com/NFC%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F.003.jpeg)

PN532模块寻卡成功，即找到卡之后返回如下数据：

```
00 00 FF 00 FF 00 00 00 FF 0C F4 D5 4B 01 01 00 04 08 04 40 10 9B A5 3E 00 
```

寻卡响应数据的详细解释如下图：

![寻卡响应](http://onmw6wg88.bkt.clouddn.com/NFC%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F.004.jpeg)

其中标红的就是我们要找的卡的UID，也就是卡的身份证号码，这个号码可以用来识别是哪张卡。

这里需要注意的是，如果识别出了问题，可能就会出现其他乱码，至于乱码是什么意思，那就只能请各位老板去看PN532芯片的[Data Sheet](http://www.dfrobot.com.cn/image/data/DFR0231/pn532ds.pdf)和[User Manual](http://www.dfrobot.com.cn/image/data/DFR0231/pn532um.pdf)了。其实只要不是这个格式，基本上就是你代码的问题了，和卡以及模块无关，请不要怀疑～～

### 三、验证

好了，到了激动人心的卡片密码验证环节了，在验证密码之前，我们先来看一下S50卡的存储机制，来一张性感图片：

![存储机制](http://onmw6wg88.bkt.clouddn.com/NFC%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F.005.jpeg)

图中展示了一个 1024×8 bit 的EEPROM存储器被分为16个扇区，每个区又被分为4个块，每块拥有16个字节，以图上红色框里的14号扇区为例，每个区的第4块负责存放这个区的密码，在第4块内有密码A、控制位、密码B，一般默认的是密码A，控制位是用来控制某个块的读写、增减、传输、储存的，关于控制位的详细说明请参考：[AN1304 - NFC Type MIFARE Classic Tag Operation](https://www.nxp.com/docs/en/application-note/AN1304.pdf)。

我们在使用的时候一般只关注这里的密码存放在哪里就好了，其它的可以不用关心。另外，值得一提的是**同一扇区里的四个块的密码是一样的**。所以，你在第8块用的密码和第6块一样的，但是第8块的密码和第9块的可能就不一样了。

验证命令如下：

```
00 00 FF 0F F1 D4 40 01 60 03 FF FF FF FF FF FF 40 10 9B A5 FE 00
```

验证命令详细解释如下图：

![验证命令](http://onmw6wg88.bkt.clouddn.com/NFC%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F.006.jpeg)

验证成功时PN532模块会响应如下数据：

```
00 00 FF 00 FF 00 00 00 FF 03 FD D5 41 00 EA 00
```

验证响应数据的详细解释如下图：
![验证响应](http://onmw6wg88.bkt.clouddn.com/NFC%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F.007.jpeg)

其中红色表示的为验证状态位，00表示验证通过，密码正确。有些时候可能会收到17之类的数据，这种一般是你改过这个区的密码，或者是你没有经过唤醒和寻卡操作。

### 四、读写

废了这么久的劲终于到了数据读写了，不过，这里我必须要说的是心急吃不了热豆腐，上面验证步骤里的扇区和块的注意点务必看懂了再来操作读写，不然手贱锁卡的事情不要太容易就发生在你面前了，不过好在锁了一个区还有其它区可以用，当然，土豪的话你就随意了～～

#### 1. 读取数据

读取数据的命令如下：

```
00 00 FF 05 FB D4 40 01 30 03 B8 00
```

读取数据命令的详细解释如下图：

![读取命令](http://onmw6wg88.bkt.clouddn.com/NFC%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F.008.jpeg)

读取成功时的响应数据如下：

```
00 00 FF 00 FF 00 00 00 FF 13 ED D5 41 00 00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF 01 00 
```

读取成功时的响应数据详细解释如下图：

![读取响应](http://onmw6wg88.bkt.clouddn.com/NFC%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F.009.jpeg)

效果展示如下图：

![数据读取效果图](http://onmw6wg88.bkt.clouddn.com/Snip20180425_8.png)

#### 2. 写入数据

写入数据命令如下：

```
00 00 FF 15 EB D4 40 01 A0 02 0F 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 3A 00
```

写入数据命令的详细解释如下图：

![写入请求](http://onmw6wg88.bkt.clouddn.com/NFC%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F.010.jpeg)

写入成功时的响应数据如下：

```
00 00 FF 00 FF 00 00 00 FF 03 FD D5 41 00 EA 00 
```

写入成功时响应的数据与验证成功响应的数据基本一致，详细解释如下图：

![写入响应](http://onmw6wg88.bkt.clouddn.com/NFC%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F.011.jpeg)

写入效果展示如下图：

![数据写入效果图](http://onmw6wg88.bkt.clouddn.com/Snip20180425_9.png)





